services:
  # Staging: Vue Frontend App
  - type: web
    name: staging-nawhas
    env: static
    buildCommand: cd web && yarn install --frozen-lockfile && yarn build
    staticPublishPath: ./web/dist
    pullRequestPreviewsEnabled: false
    domains:
      - staging.nawhas.com
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VUE_APP_API_DOMAIN
        value: https://api.staging.nawhas.com
  # Staging MySQL DB
  - type: pserv
    name: mysql-staging-nawhas
    plan: standard
    env: docker
    autoDeploy: false
    dockerfilePath: ./db/Dockerfile
    dockerContext: ./db
    disk:
      name: mysql
      mountPath: /var/lib/mysql
      sizeGB: 10
    envVars:
      - fromGroup: mysql
  # Staging API PHP Service
  - type: pserv
    name: api-fpm-staging-nawhas
    plan: standard
    env: docker
    autoDeploy: true
    dockerfilePath: ./api/Dockerfile
    dockerContext: ./api
    envVars:
      - key: DB_HOST
        fromService:
          name: mysql-staging-nawhas
          type: pserv
          property: host
      - key: DB_USERNAME
        fromService:
          name: mysql-staging-nawhas
          type: pserv
          envVarKey: MYSQL_USER
      - key: DB_PASSWORD
        fromService:
          name: mysql-staging-nawhas
          type: pserv
          envVarKey: MYSQL_PASSWORD

envVarGroups:
  - name: mysql
    envVars:
      - key: MYSQL_DATABASE
        value: nawhas
      - key: MYSQL_USER
        value: nawhas
      - key: MYSQL_PASSWORD
        generateValue: true
      - key: MYSQL_ROOT_PASSWORD
        generateValue: true
